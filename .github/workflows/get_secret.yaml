name: List and Display Environment Secrets1

on:
  workflow_dispatch:
    inputs:
      repo_owner:
        description: "Enter the repository owner name"
        required: true
        type: string
      repo_name:
        description: "Enter the repository name"
        required: true
        type: string
      environment_name:
        description: "Enter the environment name"
        required: true
        type: string
      personal_access_token:
        description: "Enter your Personal Access Token (PAT) with repo and admin rights"
        required: true
        type: string

jobs:
  fetch-environment-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Secrets for Specified Environment
        env:
          REPO_OWNER: ${{ github.event.inputs.repo_owner }}
          REPO_NAME: ${{ github.event.inputs.repo_name }}
          ENVIRONMENT_NAME: ${{ github.event.inputs.environment_name }}
          PAT: ${{ github.event.inputs.personal_access_token }}
        run: |
          echo "Fetching secrets for environment: $ENVIRONMENT_NAME"

          # Fetch the secrets list for the specified environment
          SECRETS=$(curl -s -H "Authorization: Bearer $PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/environments/$ENVIRONMENT_NAME/secrets" \
              | jq -r '.secrets[]?.name')

           echo "printing env secrets: $SECRETS"

          if [ -z "$SECRETS" ]; then
            echo "No secrets found for the specified environment: $ENVIRONMENT_NAME"
          else
            echo "Secrets found for environment $ENVIRONMENT_NAME:"
            echo "$SECRETS"
            
            # Iterate over each secret and fetch its value
            for SECRET in $SECRETS; do
              SECRET_VALUE=$(curl -s -H "Authorization: Bearer $PAT" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/environments/$ENVIRONMENT_NAME/secrets/$SECRET" \
                  | jq -r '.value')

              # Print key=value with spaces in the value
              echo "$SECRET=$(echo $SECRET_VALUE | sed 's/./& /g')"
            done
          fi
