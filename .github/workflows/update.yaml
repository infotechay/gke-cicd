name: Manage Secrets

on:
  workflow_dispatch:
    inputs:
      secret_type:
        description: "Select Secret Type"
        required: true
        type: choice
        options:
          - Environment secrets
          - Repository secrets
      action_type:
        description: "Select Action Type"
        required: true
        type: choice
        options:
          - Add
          - Modify
      repo_owner:
        description: "Enter Repository Owner"
        required: true
        type: string
      repo_name:
        description: "Enter Repository Name"
        required: true
        type: string
      environment_name:
        description: "Enter Environment Name (required only for Environment secrets)"
        required: false
        type: string
      secret_key:
        description: "Enter Secret Key"
        required: true
        type: string
      secret_value:
        description: "Enter Secret Value"
        required: true
        type: string
      personal_access_token:
        description: "Enter your Personal Access Token (PAT)"
        required: true
        type: string

jobs:
  manage-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: Set Variables
        id: set_vars
        run: |
          echo "SECRET_TYPE=${{ github.event.inputs.secret_type }}" >> $GITHUB_ENV
          echo "ACTION_TYPE=${{ github.event.inputs.action_type }}" >> $GITHUB_ENV
          echo "REPO_OWNER=${{ github.event.inputs.repo_owner }}" >> $GITHUB_ENV
          echo "REPO_NAME=${{ github.event.inputs.repo_name }}" >> $GITHUB_ENV
          echo "ENV_NAME=${{ github.event.inputs.environment_name }}" >> $GITHUB_ENV
          echo "SECRET_KEY=${{ github.event.inputs.secret_key }}" >> $GITHUB_ENV
          echo "SECRET_VALUE=${{ github.event.inputs.secret_value }}" >> $GITHUB_ENV
          echo "PAT=${{ github.event.inputs.personal_access_token }}" >> $GITHUB_ENV

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ env.PAT }}
        run: |
          echo "Authenticating GitHub CLI..."
          gh auth status || gh auth login --with-token <<< "${{ env.PAT }}"

      - name: Manage Secrets
        env:
          SECRET_TYPE: ${{ env.SECRET_TYPE }}
          ACTION_TYPE: ${{ env.ACTION_TYPE }}
          REPO_OWNER: ${{ env.REPO_OWNER }}
          REPO_NAME: ${{ env.REPO_NAME }}
          ENV_NAME: ${{ env.ENV_NAME }}
          SECRET_KEY: ${{ env.SECRET_KEY }}
          SECRET_VALUE: ${{ env.SECRET_VALUE }}
          PAT: ${{ env.PAT }}
        run: |
          if [[ "$SECRET_TYPE" == "Environment secrets" ]]; then
            if [[ -z "$ENV_NAME" ]]; then
              echo "Environment Name is required for Environment secrets."
              exit 1
            fi

            if [[ "$ACTION_TYPE" == "Add" ]]; then
              echo "Adding Environment Secret: $SECRET_KEY"
              echo "$SECRET_VALUE" | gh secret set $SECRET_KEY \
                --body - \
                --repo "$REPO_OWNER/$REPO_NAME" \
                --env "$ENV_NAME"
            elif [[ "$ACTION_TYPE" == "Modify" ]]; then
              echo "Modifying Environment Secret: $SECRET_KEY"
              echo "$SECRET_VALUE" | gh secret set $SECRET_KEY \
                --body - \
                --repo "$REPO_OWNER/$REPO_NAME" \
                --env "$ENV_NAME"
            fi
          elif [[ "$SECRET_TYPE" == "Repository secrets" ]]; then
            if [[ "$ACTION_TYPE" == "Add" ]]; then
              echo "Adding Repository Secret: $SECRET_KEY"
              echo "$SECRET_VALUE" | gh secret set $SECRET_KEY \
                --body - \
                --repo "$REPO_OWNER/$REPO_NAME"
            elif [[ "$ACTION_TYPE" == "Modify" ]]; then
              echo "Modifying Repository Secret: $SECRET_KEY"
              echo "$SECRET_VALUE" | gh secret set $SECRET_KEY \
                --body - \
                --repo "$REPO_OWNER/$REPO_NAME"
            fi
          else
            echo "Invalid Secret Type Selected."
            exit 1
          fi
